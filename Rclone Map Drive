#download files
#unzip 
#create conf
#reg entries
#run mount 
#startup command for machine 
#shortcut in startup and program files in case of crashing
#change data to program files
#invoke web request
#user script , owner of explorer.exe. Run cmd as user
#ask for drive letter

$rclonedir="C:\Program Files\Rclone"
$RemoteName="Sharepoint"
$MapDriveName="\\server\shared"
$tag = (Invoke-WebRequest "https://api.github.com/repos/rclone/rclone/releases/latest" | ConvertFrom-Json)[0].tag_name

$rclonecfg= '[$RemoteName]
type = onedrive
token = {"access_token":"eyJ0eXAiOiJKV1QiLCJub25jZSI6IjRCMXpYVzR4Rk4xdFhWdWxfUFdibWJYOWNmZjFTMm02T09QVHR0clc5ZkEiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGxWMFRPSSIsImtpZCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGxWMFRPSSJ9.eyJhdWQiOiIwMDAwMDAwMy0wMDAwLTAwMDAtYzAwMC0wMDAwMDAwMDAwMDAiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC83Mjk0OWEwYi0yNzUzLTQ2YTgtOWY5NS1iODAwZTIxYjE1YjkvIiwiaWF0IjoxNjYzMDczOTI1LCJuYmYiOjE2NjMwNzM5MjUsImV4cCI6MTY2MzA3ODMzMiwiYWNjdCI6MCwiYWNyIjoiMSIsImFpbyI6IkFWUUFxLzhUQUFBQVd1SVd4Z3h2Z21pZkNNeHdibEtid2JVY0RhbU80eTlrNkQwWG5LVFJHemczLzV6OHJXWWpLaWFONklkQkVUQnJGb0toa2tianIyQmFBWTZobTl4bEdGZ3JQeFVBN2kyNUZGYjF1ZXBQTlhBPSIsImFtciI6WyJyc2EiLCJtZmEiXSwiYXBwX2Rpc3BsYXluYW1lIjoicmNsb25lIiwiYXBwaWQiOiJiMTU2NjVkOS1lZGE2LTQwOTItODUzOS0wZWVjMzc2YWZkNTkiLCJhcHBpZGFjciI6IjEiLCJkZXZpY2VpZCI6IjYyZTM4NzgwLTUzOGMtNDRjNy1hNDRkLTdlZWMyZjgwNTYzNyIsImZhbWlseV9uYW1lIjoiR2FyaW9jaCIsImdpdmVuX25hbWUiOiJTdGV2ZW4iLCJpZHR5cCI6InVzZXIiLCJpcGFkZHIiOiI3OC4zMi43MC43OSIsIm5hbWUiOiJTdGV2ZW4gR2FyaW9jaCB8IEZsb25peCBMdGQiLCJvaWQiOiJkODBjOTcyYy1lNzUxLTQzMjctODgyOS1iNzU2MWM1ZjlhMjIiLCJwbGF0ZiI6IjMiLCJwdWlkIjoiMTAwMzIwMDEyOUU5OTQ2NiIsInJoIjoiMC5BUUlBQzVxVWNsTW5xRWFmbGJnQTRoc1Z1UU1BQUFBQUFBQUF3QUFBQUFBQUFBQUNBRlUuIiwic2NwIjoiRmlsZXMuUmVhZCBGaWxlcy5SZWFkLkFsbCBGaWxlcy5SZWFkV3JpdGUgRmlsZXMuUmVhZFdyaXRlLkFsbCBTaXRlcy5SZWFkLkFsbCBwcm9maWxlIG9wZW5pZCBlbWFpbCIsInNpZ25pbl9zdGF0ZSI6WyJrbXNpIl0sInN1YiI6IlczdTQzc1hUMkxIMG9JRnkyeXFSdXM5REE4dFVMa0hUNWV6dUVfZDlDSVkiLCJ0ZW5hbnRfcmVnaW9uX3Njb3BlIjoiRVUiLCJ0aWQiOiI3Mjk0OWEwYi0yNzUzLTQ2YTgtOWY5NS1iODAwZTIxYjE1YjkiLCJ1bmlxdWVfbmFtZSI6IlN0ZXZlbi5HYXJpb2NoQGZsb25peC5jby51ayIsInVwbiI6IlN0ZXZlbi5HYXJpb2NoQGZsb25peC5jby51ayIsInV0aSI6Im14b3dZV21XVjBxcGlXRXlfanVyQUEiLCJ2ZXIiOiIxLjAiLCJ3aWRzIjpbIjI5MjMyY2RmLTkzMjMtNDJmZC1hZGUyLTFkMDk3YWYzZTRkZSIsImZlOTMwYmU3LTVlNjItNDdkYi05MWFmLTk4YzNhNDlhMzhiMSIsImI3OWZiZjRkLTNlZjktNDY4OS04MTQzLTc2YjE5NGU4NTUwOSJdLCJ4bXNfc3QiOnsic3ViIjoiS04tSTFQYVN0TzZXR09kNzVQX0VjMm5XNkZfc25JWk9ydkFOUE9kZjhrZyJ9LCJ4bXNfdGNkdCI6MTMxMTc1NDE4Nn0.BWv6J1O6UpzNIr1W1qFTW4XEKEHEqUGzvT2G5Yod7IwnxxFFnQwfZhey9trtMcgiRRfp62Gp58BxksYvDCYoijSy43d1gS-pn5E-KpUC4I9I0qPujsw3w5Rq4c4F7JAG6yzqlodQwKFEYFmfUvGgzVrcnX8BsrEy0FEMzMrUTA5x_Db5tp-lAdNwb39UgBC-qBPXqoUB3BTZzUGvvAvqOiyzLMy2HMgaZzrv_BjNmyDszenXmGwlTyWxYX-izIiJS6KFkuyx2btZfJFEpiSqgPb3epKndr9n4TyKsSYpUPgAACfrKngzfStLsX2ZUG7mIolUlBSdcoU_ibXc8DN5iQ","token_type":"Bearer","refresh_token":"0.AQIAC5qUclMnqEaflbgA4hsVudllVrGm7ZJAhTkO7Ddq_VkCAFU.AgABAAEAAAD--DLA3VO7QrddgJg7WevrAgDs_wQA9P9Qj0fOBRg9yEzcVaAN6Uel0j4hTTWjdDQeYGTgqLNLefSeGhETk3ySvY4A1TcGkLIREzMDmyWMYr_dIbuOyzI1-vgZsw_sB-8P4Di19wiS5lNQ4Nb1ys4Wu3k0hJxp6FAOkTsjnTogWDtP6hTJWklbhB_nL1lilaNSZj_CSa5aY_Y8poJ2pxQhp8T7X16Y8btWNwOFRDIFqgcg5YL3jR32JWzWxzL-HKsvly2FvnBMjFx7AY2gS7CENv5iPWATa001-_4EDpt-VZQMKixgqPWlN3dv8EWHK9BZQMkLup7TisTaokgqyrBE2ZrU23K00vFENDK8Z4YgM7osoDzj3PnwfrHxhF1B1v3aTFlGIK1WoLCttbjGuZvBjbZpgDHGppj8DgSN7mc9R1iAhfCYsshT6MJqYyQaf9I2Jr2U7a9nlNM7IyRLpFyk3NStHT-5t2uYr4PukklJNVXhRzRqSe6VDOaWyosKKvVGFJgQLEx6-oE0IOkSC2r0tiQlNsf8Oz0tGCURCKCWHlbT5HmmV6cm48kSOba6TQxzKzi3KsMZ8NycMK-igXCjjkaumFWldGqV54MHX07cmTVShdr0Cd0aic7w_MPA8A4hnO5Lg0isMsJy78s8y-XD6dX2EJouh8nML7sVVb1Qmdn-GJL3kjHgDC9C2rZ4xa5OySx7p5Ce1ZYWtDoKPvzhSc2zO48KK8DitPFHkw5QWyCt6e7thpytzXivqDUNWLnUfVfv-BH7P6Tm-62ms2HETBXQM3sGvv970Pf4j29LSkSvGySmt_b8eJ1oxLhBiV4MqKmkLYrCptHS6EOM60aheRb1iURKCnzmCgFsUJa_BKc0LYIDJScMZ49zSa1G5-Y9gpagmNrOToZ_Vb1EZg1FvBuY8V-hT-A05MoVZll73z6VkKmB548BI_0kiku0yBT4AtikQyGPdQuPUgH6YKhIDJab9oqkoEqQrX3_hH0ZPjcbjplebu4IYF0JDRbktsrQeCJlzuaLzFFUh_AllGLrIGsmAzzSaRUheDZPmLct","expiry":"2022-09-13T15:12:11.1298765+01:00"}
drive_id = b!76pILDZTdUGSVaWoHD5-BkeDqmh71bVEsJFeZk6AXwrDYxiJwK-7T5xokBqVOFrz
drive_type = business'

$MapDriveBat= 'cmd.exe cd $rclonedir 
cmd.exe rclone mount $RemoteName:/ P: --volname $MapDriveName --vfs-cache-mode off --no-console --log-file %LOCALAPPDATA%\rclone\logs\driveP.txt' 

#new-item c:\ProgramData\rclone -itemtype directory

#Get and expand programs
new-item $rclonedir -itemtype directory
Invoke-WebRequest -Uri "https://github.com/rclone/rclone/releases/download/$tag/rclone-$tag-windows-amd64.zip" -outfile "rclonedir\rclone.zip"
Invoke-WebRequest -Uri "https://github.com/winfsp/winfsp/releases/download/v1.11/winfsp-1.11.22176.msi" -outfile "$rclonedir\winfsp.msi"
Expand-Archive -LiteralPath $rclonedir\rclone.zip -DestinationPath $rclonedir -Force
Copy-Item $rclonedir\rclone-$tag-windows-amd64 -Destination $rclonedir
Remove-Item "C:\Program Files\Rclone\rclone.zip" -Force
Remove-Item "C:\Program FIles\Rclone\Rclone" -Force

#install winfsp
Start-Process msiexec.exe -ArgumentList /i /quiet /passive /qn /norestart $rclonedir\winfsp.msi

#generate Rclone config
Set-Content %appdata%\rclone\rclone.conf

#update token for current user
cd $rclonedir
rclone config update default config_refresh_token=true
rclone mount $RemoteName:/ P: --volname $MapDriveName --vfs-cache-mode off --no-console --log-file %LOCALAPPDATA%\rclone\logs\driveP.txt

#write startup entry
Set-Content $rclonedir\MapNetworkDrive.bat $MapDriveBat
Copy-Item $rclonedir\MapNetworkDrive.bat -Destination "%HOMEPATH%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup" #user startup 
